# Local development without GPU
# Usage: docker compose -f docker-compose.local.yml up -d

services:
  clawdbot-desktop-worker:
    build: .
    container_name: clawdbot-desktop-worker-local
    restart: unless-stopped

    environment:
      DISPLAY: ":0"
      XDG_RUNTIME_DIR: "/tmp/runtime-developer"

      # Auth
      VNC_PASSWORD: ${VNC_PASSWORD:-clawdbot}

      # No GPU
      NVIDIA_VISIBLE_DEVICES: ""

      CLAWDBOT_HOME: /clawdbot_home
      WORKSPACE: /workspace
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

    shm_size: '1gb'

    ports:
      - "8080:8080"   # Guacamole-Lite HTML5
      - "18789:18789" # Clawdbot Gateway

    volumes:
      - clawdbot_home_local:/clawdbot_home
      - clawdbot_workspace_local:/workspace

    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/health | grep -q '200'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # Full Apache Guacamole Stack (alternative to guacamole-lite)
  # Access via localhost:8888/guacamole
  # Default login: guacadmin / guacadmin
  # =============================================================================

  guacamole-db:
    image: mariadb:10.11
    container_name: guacamole-db-local
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${GUAC_DB_ROOT_PASSWORD:-guacamole_root_pass}
      MYSQL_DATABASE: guacamole_db
      MYSQL_USER: guacamole_user
      MYSQL_PASSWORD: ${GUAC_DB_PASSWORD:-guacamole_pass}
    volumes:
      - guacamole_db_local:/var/lib/mysql
      - ./config/guacamole/initdb.sql:/docker-entrypoint-initdb.d/initdb.sql:ro
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  guacamole-full:
    image: guacamole/guacamole:1.5.5
    container_name: guacamole-full-local
    restart: unless-stopped
    depends_on:
      guacamole-db:
        condition: service_healthy
      clawdbot-desktop-worker:
        condition: service_healthy
    environment:
      # Connect to guacd running inside the worker container
      GUACD_HOSTNAME: clawdbot-desktop-worker-local
      GUACD_PORT: 4822

      # Database connection
      MYSQL_HOSTNAME: guacamole-db-local
      MYSQL_PORT: 3306
      MYSQL_DATABASE: guacamole_db
      MYSQL_USER: guacamole_user
      MYSQL_PASSWORD: ${GUAC_DB_PASSWORD:-guacamole_pass}

    ports:
      - "8888:8080"   # Full Guacamole UI

volumes:
  clawdbot_home_local:
  clawdbot_workspace_local:
  guacamole_db_local:
