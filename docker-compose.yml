services:
  clawdbot-desktop-worker:
    build: .
    container_name: clawdbot-desktop-worker
    restart: unless-stopped

    environment:
      # Clawdbot
      CLAWDBOT_HOME: /clawdbot_home
      WORKSPACE: /workspace
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

      # Auth (VNC_PASSWORD for both x11vnc and Guacamole web auth)
      VNC_PASSWORD: ${VNC_PASSWORD:-clawdbot}

      # GPU (for desktop apps that use GPU acceleration)
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: all

    deploy:
      resources:
        limits:
          cpus: "42"  # 66% of 64 cores
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu", "compute", "utility", "video"]

    # Required for Chrome shared memory
    shm_size: '2gb'

    # Required for Flatpak apps (bubblewrap needs user namespaces)
    privileged: true

    # Ports exposed via Traefik labels (loadbalancer.server.port)
    # - 8080: Guacamole-Lite HTML5 client
    # - 4822: guacd protocol (exposed for full Guacamole)
    # - 18789: Clawdbot Gateway (add second domain in Coolify if needed)

    volumes:
      - clawdbot_home:/clawdbot_home
      - clawdbot_workspace:/workspace
      # Optional: Docker socket for sandboxes
      # - /var/run/docker.sock:/var/run/docker.sock

    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/health | grep -q '200'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      - traefik.enable=true
      # Route to Guacamole-Lite on port 8080
      - traefik.http.services.clawdbot-desktop-worker.loadbalancer.server.port=8080
      # HTTP router (Cloudflare handles HTTPS)
      - traefik.http.routers.clawdbot-desktop.rule=Host(`g1.machinemachine.ai`)
      - traefik.http.routers.clawdbot-desktop.entrypoints=http
      - traefik.http.routers.clawdbot-desktop.service=clawdbot-desktop-worker

  # =============================================================================
  # Full Apache Guacamole Stack (alternative to guacamole-lite)
  # Access via g2.machinemachine.ai or localhost:8888
  # =============================================================================

  guacamole-db:
    image: mariadb:10.11
    container_name: guacamole-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${GUAC_DB_ROOT_PASSWORD:-guacamole_root_pass}
      MYSQL_DATABASE: guacamole_db
      MYSQL_USER: guacamole_user
      MYSQL_PASSWORD: ${GUAC_DB_PASSWORD:-guacamole_pass}
    volumes:
      - guacamole_db:/var/lib/mysql
      - ./config/guacamole/initdb.sql:/docker-entrypoint-initdb.d/initdb.sql:ro
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  guacamole-full:
    image: guacamole/guacamole:1.5.5
    container_name: guacamole-full
    restart: unless-stopped
    depends_on:
      guacamole-db:
        condition: service_healthy
      clawdbot-desktop-worker:
        condition: service_healthy
    environment:
      # Connect to guacd running inside the worker container
      GUACD_HOSTNAME: clawdbot-desktop-worker
      GUACD_PORT: 4822

      # Database connection
      MYSQL_HOSTNAME: guacamole-db
      MYSQL_PORT: 3306
      MYSQL_DATABASE: guacamole_db
      MYSQL_USER: guacamole_user
      MYSQL_PASSWORD: ${GUAC_DB_PASSWORD:-guacamole_pass}

      # Optional: enable TOTP two-factor auth
      # TOTP_ENABLED: "true"

    labels:
      - traefik.enable=true
      # Route to Guacamole Full on port 8888 (internally 8080)
      - traefik.http.services.guacamole-full.loadbalancer.server.port=8080
      # HTTP router for full Guacamole
      - traefik.http.routers.guacamole-full.rule=Host(`g2.machinemachine.ai`)
      - traefik.http.routers.guacamole-full.entrypoints=http
      - traefik.http.routers.guacamole-full.service=guacamole-full

volumes:
  clawdbot_home:
  clawdbot_workspace:
  guacamole_db:
